# Image Upload

It is so common for websites to allow users to upload images that we should probably get some experience doing it. 

## Node stuff

You should create a new Express project and add to it a directory named `uploads`.

You should also install the <a href="https://github.com/expressjs/multer">multer</a> middleware.

```
npm install multer --save
```

To generate unique names for uploaded files, you can use [uid-safe](https://github.com/crypto-utils/uid-safe).

```
npm install uid-safe --save
```

Once these modules are installed, you need to `require` them and configure `multer` in your main module.

```js
var multer = require('multer');
var uidSafe = require('uid-safe');
var path = require('path');

var diskStorage = multer.diskStorage({
    destination: function (req, file, callback) {
        callback(null, __dirname + '/uploads');
    },
    filename: function (req, file, callback) {
      uidSafe(24).then(function(uid) {
          callback(null, uid + path.extname(file.originalname));
      });
    }
});

var uploader = multer({
    storage: diskStorage,
    limits: {
        fileSize: 2097152
    }
});
```

In the example above, the object returned from the call to `multer.diskStorage` specifies functions that `multer` should use for determining the path and filename to use when saving files. The `destination` function tells `multer` to put files in the `uploads` directory and the `filename` function tells `multer` to use as the file name the unique id generated by the call to `uidSafe` with the extension of the original file name appended to it.

The `diskStorage` object is then passed to `multer`, along with an object specifying a file size limit (2MB). It is a good idea to place such limits to prevent DOS attacks. The full list of limits you can apply is available <a href="https://github.com/mscdex/busboy#busboy-methods">here</a>

The object returned from this call to `multer` has middleware functions attached to it that can be used  to handle uploads on specific routes. You do not want to pass any of these functions to `app.use` because you only want to allow uploads on specific routes.

```js
app.post('/upload', uploader.single('file'), function(req, res) {
    // If nothing went wrong the file is already in the uploads directory
    if (req.file) {
        res.json({
            success: true
        });
    } else {
        res.json({
            success: false
        });
    }
});
```

The call to `single` indicates that we are only expecting one file. The string passed to `single` is the name of the field in the request.

## Browser stuff

To get start, we'll need an `<input>` element on our page whose `type` attribute has the value `"file"`.

```html
<input type="file" accept="image/*">
```

The `accept` attribute tells the browser to disallow files that are not images.

For a long time it was not possible to do an image upload via ajax but now it is due to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData">`FormData` API</a>. Here's how it works. First, you get the file the user has specified in the form:

```js
var file = myFileInput.files[0];
```

Then you create a `FormData` instance and `append` the file to it.

```js
var formData = new FormData();
formData.append('file', file);
```

You can then send the `FormData` instance in an ajax POST request. If you are using axios, this is very easy:

```js
axios.post('/upload', formData);
```

Things are more complicated if you are using jQuery:

```js
$.ajax({
    url: '/upload',
    method: 'POST',
    data: formData,
    processData: false,
    contentType: false
});
```

It is necessary to set both `processData` and `contentType` to `false` to prevent jQuery from doing its normal process and to allow this to be a multipart upload. Similar steps must be taken if you want to submit the `FormData` instance using <a href="https://docs.angularjs.org/api/ng/service/$http">Angular's `$http` service</a>, as explained in <a href="http://stackoverflow.com/questions/37039852/send-formdata-with-other-field-in-angular?answertab=votes#tab-top">this Stack Overflow answer</a>.

After the image has been uploaded, you can display it to the user if you have passed your `/uploads` directory to `express.static` and you include the path + filename in the JSON response you send back to the browser. This would be fine for a devlopment environment, but in a real world situation, you will want to [transfer the image to another location](../knox_s3) for permanent storage and not just keep it on the local disk.
